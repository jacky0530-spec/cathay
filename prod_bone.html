<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>新金骨力(XJ2) 內部試算</title>
    <script type="module" src="auth.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", -apple-system, sans-serif; touch-action: manipulation; }
        /* 骨骼互動樣式 */
        .bone-part { 
            transition: all 0.2s; 
            cursor: pointer; 
            fill-opacity: 0.1; 
            stroke-opacity: 0.7;
        }
        .bone-part:hover { 
            fill-opacity: 0.4; 
            stroke-width: 3;
        }
        .selected { 
            fill-opacity: 0.8 !important; 
            stroke-width: 3px !important; 
            stroke-opacity: 1 !important; 
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.3)); 
        }
        
        /* 顏色定義 */
        .bone-green { stroke: #059669; fill: #34d399; } /* 頭部 */
        .bone-red { stroke: #dc2626; fill: #f87171; }   /* 軀幹 */
        .bone-blue { stroke: #2563eb; fill: #60a5fa; }  /* 四肢 */

        /* 動畫 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-anim { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div id="root"></div>

<script type="text/babel">
    const { useState, useRef, useEffect } = React;

    // 依據 XJ2 保單條款定義的骨折給付比例
    const BONE_DATA = [
        // --- 頭部 (綠色) ---
        { id: 'skull', label: '頭蓋骨', pct: 60, type: 'green', note: '項次14: 頭蓋骨', path: 'M130 20 C105 20 85 35 85 60 C85 75 90 85 100 90 L160 90 C170 85 175 75 175 60 C175 35 155 20 130 20 Z' },
        { id: 'face', label: '鼻骨/眶骨', pct: 12, type: 'green', note: '項次3: 鼻骨、眶骨(含顴骨)', path: 'M100 90 L95 110 L165 110 L160 90 Z' },
        { id: 'jaw', label: '下顎骨', pct: 20, type: 'green', note: '項次8: 下顎(齒槽除外)', path: 'M95 110 Q130 135 165 110 L160 125 Q130 145 100 125 Z' },
        
        // --- 軀幹 (紅色) ---
        { id: 'clavicle', label: '鎖骨', pct: 30, type: 'red', note: '項次7: 鎖骨', path: 'M70 135 Q130 145 190 135 L190 145 Q130 155 70 145 Z' },
        { id: 'scapula', label: '肩胛骨', pct: 35, type: 'red', note: '項次11: 肩胛骨', path: 'M60 145 L40 160 L50 190 L70 160 Z M200 145 L220 160 L210 190 L190 160 Z' },
        { id: 'ribs', label: '肋骨', pct: 20, type: 'red', note: '項次6: 肋骨', path: 'M90 150 Q60 180 90 220 H170 Q200 180 170 150 Z' },
        { id: 'spine', label: '椎骨(脊椎)', pct: 40, type: 'red', note: '項次12: 椎骨(胸/腰/尾)', path: 'M125 140 L135 140 L135 230 L125 230 Z' },
        
        // --- 下肢與骨盆 (藍色) ---
        { id: 'pelvis', label: '骨盤', pct: 40, type: 'blue', note: '項次13: 骨盤(腸/恥/坐/薦)', path: 'M85 230 Q65 240 85 270 Q130 290 175 270 Q195 240 175 230 Z' },
        
        { id: 'femur_neck', label: '大腿骨頸', pct: 80, type: 'blue', note: '項次22: 大腿骨頸 (最高比例)', path: 'M80 270 L70 285 L85 290 L95 275 Z M180 270 L190 285 L175 290 L165 275 Z' },
        { id: 'femur', label: '股骨(大腿)', pct: 60, type: 'blue', note: '項次20: 股骨', path: 'M70 285 L65 370 L85 370 L90 285 Z M190 285 L195 370 L175 370 L170 285 Z' },
        { id: 'patella', label: '膝蓋骨', pct: 30, type: 'blue', note: '項次10: 膝蓋骨', path: 'M65 375 A10 10 0 1 1 85 375 A10 10 0 1 1 65 375 M175 375 A10 10 0 1 1 195 375 A10 10 0 1 1 175 375' },
        { id: 'tibia', label: '小腿骨(單)', pct: 40, type: 'blue', note: '項次18/21: 脛骨或腓骨40% (雙骨折60%)', path: 'M65 390 L60 470 L85 470 L90 390 Z M195 390 L200 470 L175 470 L170 390 Z' },
        
        // --- 足部細分 (藍色) ---
        { id: 'ankle', label: '踝骨', pct: 40, type: 'blue', note: '項次19: 踝骨', path: 'M60 475 L55 490 L90 490 L85 475 Z M200 475 L205 490 L170 490 L175 475 Z' },
        { id: 'meta_foot', label: '蹠骨(腳掌)', pct: 12, type: 'blue', note: '項次5: 蹠骨', path: 'M55 492 L50 510 L95 510 L90 492 Z M205 492 L210 510 L165 510 L170 492 Z' },
        { id: 'toes', label: '趾骨(腳趾)', pct: 3, type: 'blue', note: '項次2: 趾骨', path: 'M50 512 L45 525 L100 525 L95 512 Z M210 512 L215 525 L160 525 L165 512 Z' },

        // --- 上肢細分 (藍色) ---
        { id: 'humerus', label: '臂骨(上臂)', pct: 40, type: 'blue', note: '項次15: 臂骨', path: 'M60 150 L40 200 L55 200 L75 150 Z M200 150 L220 200 L205 200 L185 150 Z' },
        { id: 'forearm', label: '前臂(單)', pct: 30, type: 'blue', note: '項次9/16: 橈骨或尺骨30% (雙骨折40%)', path: 'M40 205 L30 250 L45 250 L55 205 Z M220 205 L230 250 L215 250 L205 205 Z' },
        { id: 'wrist', label: '腕骨', pct: 40, type: 'blue', note: '項次17: 腕骨', path: 'M30 252 L25 262 L50 262 L45 252 Z M230 252 L235 262 L210 262 L215 252 Z' },
        { id: 'meta_hand', label: '掌骨', pct: 12, type: 'blue', note: '項次4: 掌骨', path: 'M25 264 L20 280 L55 280 L50 264 Z M235 264 L240 280 L205 280 L210 264 Z' },
        { id: 'fingers', label: '指骨', pct: 3, type: 'blue', note: '項次1: 指骨', path: 'M20 282 L15 300 L60 300 L55 282 Z M240 282 L245 300 L200 300 L205 282 Z' },
    ];

    function App() {
        const [insuranceAmount, setInsuranceAmount] = useState(1000000); // 預設 100 萬
        const [selectedItems, setSelectedItems] = useState([]);
        const scrollRef = useRef(null);

        const toggleItem = (item) => {
            setSelectedItems(prev => {
                const exists = prev.find(i => i.id === item.id);
                if (exists) return prev.filter(i => i.id !== item.id);
                
                // 新增項目時自動捲動到底部
                setTimeout(() => {
                    if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }, 100);
                return [...prev, item];
            });
        };

        const formatCurrency = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));

        return (
            <div className="h-screen flex flex-col bg-slate-50 overflow-hidden">
                {/* Header */}
                <div className="bg-white shadow-sm p-3 z-10 text-center">
                    <h1 className="text-lg font-bold text-teal-700">新金骨力(XJ2) 精細試算</h1>
                    <div className="mt-2 flex justify-center items-center text-sm">
                        <span className="text-gray-500 mr-2">保額:</span>
                        <input 
                            type="number" 
                            value={insuranceAmount}
                            onChange={(e) => setInsuranceAmount(Number(e.target.value))}
                            className="w-24 text-center font-bold text-lg border-b border-teal-500 outline-none bg-transparent"
                        />
                        <span className="text-gray-500 ml-1">元</span>
                    </div>
                </div>

                {/* Main Content */}
                <div className="flex-1 overflow-y-auto relative" ref={scrollRef}>
                    <div className="p-4 flex flex-col items-center pb-32">
                        
                        {/* 骨骼圖互動區 */}
                        <div className="relative mb-6">
                            <div className="absolute top-0 right-0 bg-white/80 p-2 rounded text-xs text-gray-400 shadow backdrop-blur-sm pointer-events-none">
                                <div><span className="inline-block w-2 h-2 bg-green-400 rounded-full mr-1"></span>頭部</div>
                                <div><span className="inline-block w-2 h-2 bg-red-400 rounded-full mr-1"></span>軀幹</div>
                                <div><span className="inline-block w-2 h-2 bg-blue-400 rounded-full mr-1"></span>四肢</div>
                            </div>
                            <svg viewBox="0 0 260 540" className="w-64 drop-shadow-lg touch-none select-none">
                                {BONE_DATA.map((bone) => {
                                    const isSelected = selectedItems.find(i => i.id === bone.id);
                                    return (
                                        <path 
                                            key={bone.id}
                                            d={bone.path}
                                            className={`bone-part bone-${bone.type} ${isSelected ? 'selected' : ''}`}
                                            onClick={() => toggleItem(bone)}
                                            strokeWidth="1.5"
                                        />
                                    );
                                })}
                                {/* 文字標籤輔助 */}
                                <text x="245" y="300" fontSize="10" fill="#94a3b8">指</text>
                                <text x="220" y="530" fontSize="10" fill="#94a3b8">趾</text>
                            </svg>
                            <p className="text-center text-xs text-gray-400 mt-2">點擊細部骨骼加入清單</p>
                        </div>

                        {/* 結果列表 */}
                        <div className="w-full max-w-md space-y-3">
                            {selectedItems.length === 0 ? (
                                <div className="text-center p-6 border-2 border-dashed border-gray-200 rounded-xl text-gray-400">
                                    尚未選擇部位<br/>請點擊上方人體圖
                                </div>
                            ) : (
                                selectedItems.map((item) => (
                                    <div key={item.id} className="card-anim bg-white rounded-xl shadow border border-slate-100 overflow-hidden">
                                        <div className={`px-4 py-2 flex justify-between items-center ${
                                            item.type === 'green' ? 'bg-green-50 text-green-800' :
                                            item.type === 'red' ? 'bg-red-50 text-red-800' : 'bg-blue-50 text-blue-800'
                                        }`}>
                                            <div>
                                                <span className="font-bold text-lg">{item.label}</span>
                                                <span className="text-xs ml-2 opacity-75">{item.note}</span>
                                            </div>
                                            <button onClick={() => toggleItem(item)} className="text-xl font-bold opacity-50 hover:opacity-100">×</button>
                                        </div>
                                        
                                        <div className="p-3 grid grid-cols-3 gap-2 text-center text-sm">
                                            <div className="bg-slate-50 p-2 rounded">
                                                <div className="text-xs text-gray-400 mb-1">完全骨折</div>
                                                <div className="font-bold text-slate-700 text-lg">
                                                    {item.pct}%
                                                </div>
                                                <div className="text-teal-600 font-bold text-xs mt-1">
                                                    ${formatCurrency(insuranceAmount * item.pct / 100)}
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-2 rounded">
                                                <div className="text-xs text-gray-400 mb-1">不完全(1/2)</div>
                                                <div className="font-bold text-slate-700">
                                                    {item.pct / 2}%
                                                </div>
                                                <div className="text-teal-600 font-bold text-xs mt-1">
                                                    ${formatCurrency(insuranceAmount * item.pct / 100 / 2)}
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-2 rounded">
                                                <div className="text-xs text-gray-400 mb-1">龜裂(1/4)</div>
                                                <div className="font-bold text-slate-700">
                                                    {item.pct / 4}%
                                                </div>
                                                <div className="text-teal-600 font-bold text-xs mt-1">
                                                    ${formatCurrency(insuranceAmount * item.pct / 100 / 4)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* 警語區塊 (新增) */}
                        <div className="w-full text-center mt-8 px-4">
                            <p className="text-red-500 font-bold text-sm bg-red-50 border border-red-200 rounded p-2">
                                ※ 本試算畫面僅供內部教育訓練，實際理賠數值 請按照保單條款為準。
                            </p>
                        </div>
                    </div>
                </div>

                {/* 底部重置按鈕 */}
                {selectedItems.length > 0 && (
                    <div className="absolute bottom-5 left-0 right-0 flex justify-center z-20 pointer-events-none">
                        <button 
                            onClick={() => setSelectedItems([])}
                            className="pointer-events-auto bg-slate-800 text-white px-6 py-3 rounded-full shadow-lg font-bold hover:bg-slate-700 active:scale-95 transition-all flex items-center gap-2"
                        >
                            <span>清除全部</span>
                            <span className="bg-white text-slate-800 rounded-full w-5 h-5 flex items-center justify-center text-xs">
                                {selectedItems.length}
                            </span>
                        </button>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>