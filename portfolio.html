<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æŠ•è³‡æˆ°æƒ…å®¤ V9.2 (æ·±åº¦æŠ•é¡§ç‰ˆ)</title>
    <style>
        :root { --bg:#0f172a; --card:#1e293b; --text:#f8fafc; --sub:#94a3b8; --green:#10b981; --red:#ef4444; --blue:#3b82f6; --purple:#8b5cf6; --border:#334155; }
        body { font-family:'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; }
        
        .header-panel { width:100%; max-width:1200px; display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px; }
        .summary-card { flex:1; min-width:250px; background:linear-gradient(145deg,#1e293b,#0f172a); padding:20px; border-radius:12px; border:1px solid var(--border); }
        .summary-val { font-size:2rem; font-weight:bold; font-family:monospace; }
        
        .controls { width:100%; max-width:1200px; background:var(--card); padding:15px; border-radius:12px; display:flex; gap:15px; align-items:center; flex-wrap:wrap; border:1px solid var(--border); margin-bottom:20px; }
        input { background:#020617; border:1px solid var(--border); color:#fff; padding:8px; border-radius:6px; width: 250px; }
        button { background:var(--blue); color:white; border:none; padding:10px 15px; border-radius:6px; cursor:pointer; font-weight:bold; }
        button:disabled { background:var(--sub); cursor:not-allowed; opacity: 0.7; }
        button.calc-btn { background:var(--purple); box-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }
        
        .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(380px,1fr)); gap:20px; width:100%; max-width:1200px; }
        .stock-card { background:var(--card); border-radius:12px; padding:20px; border:1px solid var(--border); position:relative; }
        
        .card-header { display:flex; justify-content:space-between; margin-bottom:10px; }
        .symbol { font-size:1.8rem; font-weight:900; }
        .current-price { font-size:1.8rem; font-weight:bold; font-family:monospace; color:#fbbf24; text-align:right; }
        
        .strategy-badge { font-size:0.75rem; padding:4px 8px; border-radius:4px; display:inline-block; margin-top:5px; font-weight:bold; }
        .strat-trend { background:rgba(59, 130, 246, 0.2); color:#93c5fd; border:1px solid rgba(59, 130, 246, 0.4); } 
        .strat-swing { background:rgba(168, 85, 247, 0.2); color:#d8b4fe; border:1px solid rgba(168, 85, 247, 0.4); } 
        .strat-value { background:rgba(245, 158, 11, 0.2); color:#fcd34d; border:1px solid rgba(245, 158, 11, 0.4); } 

        .target-section { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px; }
        .target-box { padding:10px; border-radius:8px; text-align:center; position:relative; }
        .target-label { font-size:0.75rem; opacity:0.8; margin-bottom:4px; }
        .target-price { font-size:1.2rem; font-weight:bold; font-family:monospace; }
        .box-buy { background:rgba(16,185,129,0.1); border:1px solid var(--green); color:var(--green); }
        .box-sell { background:rgba(239,68,68,0.1); border:1px solid var(--red); color:var(--red); }
        
        /* âœ¨ æ·±åº¦æˆ°è¡“æŒ‡å°å€å¡Š */
        .advice-container { margin:15px 0; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
        .advice-header { padding:8px 12px; font-size:0.85rem; font-weight:bold; display:flex; align-items:center; gap:5px; }
        .advice-content { padding:12px; font-size:0.9rem; line-height:1.6; background:rgba(255,255,255,0.02); color:#e2e8f0; }
        .advice-content ul { margin:0; padding-left:20px; }
        .advice-content li { margin-bottom:4px; }
        
        /* ç‹€æ…‹é¡è‰² */
        .status-bull { background:rgba(16,185,129,0.2); color:#6ee7b7; border-bottom:1px solid var(--green); }
        .status-bear { background:rgba(239,68,68,0.2); color:#fca5a5; border-bottom:1px solid var(--red); }
        .status-wait { background:rgba(59,130,246,0.2); color:#93c5fd; border-bottom:1px solid var(--blue); }

        .tv-analysis-container { height: 260px; width: 100%; margin: 10px 0; border-radius: 8px; overflow: hidden; border: 1px solid var(--border); background:#131722; }
        .data-row { display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem; }
        .pl-block { background:rgba(0,0,0,0.2); padding:10px; margin-top:15px; display:grid; grid-template-columns:1fr 1fr; text-align:center; border-radius:8px; }
        .up { color:var(--green); } .down { color:var(--red); }
        .del-btn { position:absolute; top:10px; right:10px; background:none; color:#475569; font-size:1.2rem; padding:0; cursor:pointer; }
        .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:100; }
        .modal { background:var(--card); padding:25px; border-radius:12px; width:300px; border:1px solid var(--border); }
        .progress-bar { width: 100%; height: 4px; background: #334155; position: fixed; top: 0; left: 0; }
        .progress-fill { height: 100%; background: var(--purple); width: 0%; transition: width 0.5s; }
    </style>
</head>
<body>

    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>

    <div class="header-panel">
        <div class="summary-card">
            <div style="color:var(--sub)">ç¸½è³‡ç”¢ (é ä¼°å°å¹£)</div>
            <div class="summary-val" style="color:#fbbf24" id="total-equity-twd">NT$ 0</div>
            <div style="font-size:0.8rem; color:var(--sub)">å«åº«å­˜ç¾é‡‘: <span id="total-equity-usd" style="color:#818cf8">$0.00</span></div>
        </div>
        <div class="summary-card">
            <div style="color:var(--sub)">ç¸½æœªå¯¦ç¾æç›Š</div>
            <div class="summary-val" id="total-unrealized">NT$ 0</div>
        </div>
    </div>

    <div class="controls">
        <div style="display:flex; flex-direction:column; gap:4px; flex:2;">
            <label style="font-size:0.75rem; color:var(--sub)">Twelve Data API Key</label>
            <input type="text" id="apiKey" placeholder="è«‹è²¼ä¸Š Twelve Data Key">
        </div>
        <div style="display:flex; flex-direction:column; gap:4px;">
            <label style="font-size:0.75rem; color:var(--sub)">USD/TWD</label>
            <input type="number" id="exchangeRate" value="32.5" step="0.1" style="width:70px;" onchange="updateAll()">
        </div>
        <button onclick="startDeepAnalysis()" class="calc-btn" id="calcBtn">ğŸ§  æ·±åº¦æˆ°è¡“åˆ†æ</button>
        <button onclick="openAddModal()" style="background:var(--green)">+ æ–°å¢</button>
        <button onclick="resetDb()" style="background:transparent; border:1px solid var(--border); color:var(--sub)">é‡ç½®</button>
    </div>

    <div id="status-msg" style="color:var(--sub); margin-bottom:10px; font-size:0.9rem;"></div>
    <div class="grid" id="portfolio-grid"></div>
    <div class="modal-overlay" id="addModal"><div class="modal"><h3>æ–°å¢è‚¡ç¥¨</h3><input type="text" id="new-symbol" placeholder="ä»£è™Ÿ (å¦‚ ARKW)" style="width:100%; margin-bottom:20px; box-sizing:border-box;"><div style="text-align:right;"><button onclick="confirmAdd()">æ–°å¢</button> <button onclick="document.getElementById('addModal').style.display='none'" style="background:transparent; border:1px solid var(--border)">å–æ¶ˆ</button></div></div></div>

    <script>
        const INITIAL_PORTFOLIO = [
            { symbol: 'VOO', name: 'æ¨™æ™®500', shares: 0, cost: 0 },
            { symbol: 'NVDA', name: 'NVIDIA', shares: 215, cost: 7929.17 },
            { symbol: 'TSLA', name: 'Tesla', shares: 9, cost: 2728 },
            { symbol: 'AMD', name: 'AMD', shares: 10, cost: 2209.51 },
            { symbol: 'ARKW', name: 'ARK Next Gen', shares: 22, cost: 3535.06 }
        ];

        let portfolio = [];
        let prices = {};

        window.onload = function() {
            const k = localStorage.getItem('twelvedata_key');
            if(k) document.getElementById('apiKey').value = k;
            loadDb(); render(); 
        };

        function loadDb() {
            const d = localStorage.getItem('ai_port_v9_2');
            portfolio = d ? JSON.parse(d) : JSON.parse(JSON.stringify(INITIAL_PORTFOLIO));
        }
        function saveDb() { localStorage.setItem('ai_port_v9_2', JSON.stringify(portfolio)); updateAll(); }
        function resetDb() { if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) { localStorage.removeItem('ai_port_v9_2'); location.reload(); } }

        // --- æ ¸å¿ƒï¼šåˆ†ææµç¨‹ ---
        async function startDeepAnalysis() {
            const key = document.getElementById('apiKey').value.trim();
            if(!key) { alert("è«‹è¼¸å…¥ Twelve Data API Key"); return; }
            localStorage.setItem('twelvedata_key', key);

            const btn = document.getElementById('calcBtn');
            const status = document.getElementById('status-msg');
            btn.disabled = true;
            
            for(let i=0; i<portfolio.length; i++) {
                const s = portfolio[i];
                const pct = ((i) / portfolio.length) * 100;
                document.getElementById('progressBar').style.width = pct + '%';
                btn.innerText = `â³ åˆ†æä¸­ (${i+1}/${portfolio.length})`;
                status.innerText = `æ­£åœ¨ç ”åˆ¤ ${s.symbol} çš„æŠ€è¡“é¢å½¢æ…‹...`;
                
                updateAdviceUI(s.symbol, { status: "loading", html: "AI æ­£åœ¨è®€å– K ç·šé€²è¡Œé‹ç®—..." });

                try {
                    const res = await fetch(`https://api.twelvedata.com/time_series?symbol=${s.symbol}&interval=1day&outputsize=70&apikey=${key}`);
                    const data = await res.json();
                    
                    if(data.values) {
                        const candles = data.values.reverse().map(c => parseFloat(c.close));
                        const currentPrice = candles[candles.length - 1];
                        prices[s.symbol] = currentPrice;
                        document.getElementById(`price-${s.symbol}`).innerText = `$${currentPrice.toLocaleString()}`;
                        updateCardPl(s);

                        // ç­–ç•¥è¨ˆç®—
                        const strategy = determineStrategy(s.symbol);
                        const result = generateDetailedAdvice(strategy, candles, s.symbol);
                        
                        updateTargetUI(s.symbol, `$${result.buy.toFixed(2)}`, `$${result.sell.toFixed(2)}`);
                        updateAdviceUI(s.symbol, result);
                        updateStrategyBadge(s.symbol, strategy);
                    } else if (data.code === 429) {
                        status.innerText = "âš ï¸ API é™åˆ¶ä¸­ï¼Œè«‹ç¨å€™...";
                        updateAdviceUI(s.symbol, { status: "wait", html: "API é€Ÿç‡é™åˆ¶ï¼Œè«‹ 1 åˆ†é˜å¾Œå†è©¦ã€‚" });
                    }

                } catch(e) { console.error(e); }
                
                if (i < portfolio.length - 1) await new Promise(r => setTimeout(r, 8500));
            }

            document.getElementById('progressBar').style.width = '100%';
            btn.innerText = "ğŸ§  æ·±åº¦æˆ°è¡“åˆ†æ";
            btn.disabled = false;
            status.innerText = "âœ… åˆ†æå®Œæˆã€‚è«‹åƒè€ƒä¸‹æ–¹æ“ä½œå»ºè­°ã€‚";
            updateAll();
        }

        function determineStrategy(symbol) {
            if (['VOO', 'SPY', 'IVV', 'VTI'].includes(symbol)) return 'VALUE';
            if (['NVDA', 'TSM', 'SMH', 'AVGO', '2330.TW'].includes(symbol)) return 'TREND';
            return 'SWING';
        }

        // ğŸ§  AI å¤§è…¦ï¼šç”Ÿæˆã€Œè©³ç´°æ˜ç¢ºã€çš„æ“ä½œå»ºè­° (HTML æ ¼å¼)
        function generateDetailedAdvice(strategy, closes, symbol) {
            const current = closes[closes.length-1];
            let buy = 0, sell = 0;
            let status = "wait"; // bull, bear, wait
            let title = "è§€æœ›ä¸­";
            let html = "";

            if (strategy === 'VALUE') { // å­˜è‚¡ (å­£ç·š MA60)
                const ma60 = getSMA(closes, 60);
                buy = ma60; sell = ma60 * 1.15;
                const dist = (current - ma60) / ma60 * 100; // ä¹–é›¢ç‡

                if (current <= ma60 * 1.02) {
                    status = "bull"; title = "ğŸ”” åƒ¹å€¼æµ®ç¾ (è²·é»)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>è‚¡åƒ¹å›æ¸¬å­£ç·šæ”¯æ’ ($${ma60.toFixed(0)})ï¼Œé•·ç·šå®‰å…¨é‚Šéš›é«˜ã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>å»ºè­°å•Ÿå‹•åˆ†æ‰¹ä½ˆå±€ï¼Œç¬¬ä¸€ç­†è³‡é‡‘å¯æŠ•å…¥ 30%ã€‚</li>
                            <li><strong>ç›®æ¨™ï¼š</strong>é•·æœŸæŒæœ‰ï¼Œå¿½ç•¥çŸ­ç·šæ³¢å‹•ã€‚</li>
                        </ul>`;
                } else if (dist > 10) {
                    status = "wait"; title = "âš ï¸ ä¹–é›¢éå¤§ (æš«åœ)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>ç›®å‰æ­£ä¹–é›¢é” ${dist.toFixed(1)}%ï¼Œè¿½é«˜é¢¨éšªå¢åŠ ã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>åœæ­¢å–®ç­†åŠ ç¢¼ï¼Œç¶­æŒå®šæœŸå®šé¡å³å¯ã€‚</li>
                            <li><strong>æé†’ï¼š</strong>ç­‰å¾…å›èª¿è‡³å­£ç·šé™„è¿‘å†åŠ å¤§éƒ¨ä½ã€‚</li>
                        </ul>`;
                } else {
                    status = "wait"; title = "ğŸ›¡ï¸ æŒæœ‰çºŒæŠ±";
                    html = `<ul><li><strong>ç›¤å‹¢ï¼š</strong>è‚¡åƒ¹ä½æ–¼åˆç†å€é–“ï¼Œå¤šé ­æ¶æ§‹æœªè®Šã€‚</li><li><strong>æ“ä½œï¼š</strong>çºŒæŠ±å³å¯ï¼Œç„¡é ˆé »ç¹é€²å‡ºã€‚</li></ul>`;
                }
            } 
            else if (strategy === 'TREND') { // è¶¨å‹¢ (æœˆç·š MA20)
                const ma20 = getSMA(closes, 20);
                buy = ma20; sell = ma20 * 1.25;

                if (current > ma20 * 1.01) {
                    status = "bull"; title = "ğŸš€ å¤šé ­å¼·å‹¢ (çºŒæŠ±)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>è‚¡åƒ¹ç©©ç«™æœˆç·š ($${ma20.toFixed(0)}) ä¹‹ä¸Šï¼Œæ”»æ“Šå‹•èƒ½å¼·å‹ã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>è®“ç²åˆ©å¥”è·‘ (Let profit run)ï¼Œä¸é è¨­é«˜é»ã€‚</li>
                            <li><strong>é˜²å®ˆï¼š</strong>è‹¥æ”¶ç›¤è·Œç ´ $${ma20.toFixed(0)} å‰‡æ¸›ç¢¼ 30%ã€‚</li>
                        </ul>`;
                } else if (current <= ma20 * 1.01 && current >= ma20 * 0.97) {
                    status = "bull"; title = "âš–ï¸ é—œéµæ”»é˜² (ä½ˆå±€)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>å›æ¸¬æœˆç·šæ”¯æ’ï¼Œä¸»åŠ›æ­£åœ¨é€²è¡Œé˜²å®ˆã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>è‹¥ä»Šæ—¥æ”¶ç›¤æ²’ç ´æœˆç·šï¼Œå¯å˜—è©¦åŠ ç¢¼ 20% å€‰ä½ã€‚</li>
                            <li><strong>é¢¨éšªï¼š</strong>è¨­å‰æ³¢ä½é»ç‚ºåœæã€‚</li>
                        </ul>`;
                } else {
                    status = "bear"; title = "ğŸ›‘ è¶¨å‹¢è½‰å¼± (æ¸›ç¢¼)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>å¯¦è³ªè·Œç ´æœˆç·šï¼ŒçŸ­æœŸé ­éƒ¨å½¢æˆã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>å»ºè­°å›æ”¶éƒ¨åˆ†è³‡é‡‘ï¼Œç­‰å¾…é‡æ–°ç«™å›æœˆç·šå†é€²å ´ã€‚</li>
                        </ul>`;
                }
            } 
            else { // SWING (æ³¢æ®µ - å¸ƒæ—)
                const ma20 = getSMA(closes, 20);
                const stdDev = getStdDev(closes, 20, ma20);
                const lower = ma20 - (2*stdDev);
                const upper = ma20 + (2*stdDev);
                buy = lower; sell = upper;
                
                const pctB = (current - lower) / (upper - lower); // 0=ä¸‹ç·£, 1=ä¸Šç·£

                if (pctB <= 0.15) {
                    status = "bull"; title = "âš¡ è¶…è·Œåå½ˆ (æ¶é€²)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>è§¸åŠå¸ƒæ—ä¸‹ç·£ ($${lower.toFixed(0)})ï¼ŒçŸ­ç·šä¹–é›¢éå¤§ï¼Œéš¨æ™‚åå½ˆã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>æ¿€é€²è€…å¯æ¶çŸ­å¤šï¼Œç›®æ¨™çœ‹å›ä¸­è»Œ ($${ma20.toFixed(0)})ã€‚</li>
                            <li><strong>é…ç½®ï¼š</strong>å»ºè­°æŠ•å…¥ 20% é–’ç½®è³‡é‡‘åšçŸ­æ‰“ã€‚</li>
                        </ul>`;
                } else if (pctB >= 0.85) {
                    status = "bear"; title = "ğŸ”¥ çŸ­ç·šéç†± (ç²åˆ©)";
                    html = `
                        <ul>
                            <li><strong>ç›¤å‹¢ï¼š</strong>è¡å‡ºå¸ƒæ—ä¸Šç·£ ($${upper.toFixed(0)})ï¼Œè¿½åƒ¹æ„é¡˜å°‡é™ä½ã€‚</li>
                            <li><strong>æ“ä½œï¼š</strong>å»ºè­°ç²åˆ©äº†çµ 1/3 ~ 1/2 éƒ¨ä½ï¼Œè½è¢‹ç‚ºå®‰ã€‚</li>
                        </ul>`;
                } else {
                    status = "wait"; title = "ğŸŒŠ å€é–“éœ‡ç›ª (è§€æœ›)";
                    html = `<ul><li><strong>ç›¤å‹¢ï¼š</strong>ä½æ–¼å¸ƒæ—é€šé“ä¸­é–“ï¼Œæ–¹å‘ä¸æ˜ç¢ºã€‚</li><li><strong>æ“ä½œï¼š</strong>å¤šçœ‹å°‘åšï¼Œç­‰å¾…åƒ¹æ ¼ç¢°è§¸ä¸Šä¸‹ç·£å†å‡ºæ‰‹ã€‚</li></ul>`;
                }
            }
            
            return { buy, sell, status, title, html };
        }

        function getSMA(d, p) { if(d.length<p) return d[d.length-1]; return d.slice(-p).reduce((a,b)=>a+b)/p; }
        function getStdDev(d, p, m) { if(d.length<p) return 0; const s=d.slice(-p).map(v=>Math.pow(v-m,2)); return Math.sqrt(s.reduce((a,b)=>a+b)/p); }

        function updateAdviceUI(symbol, res) {
            const el = document.getElementById(`advice-${symbol}`);
            if(!el) return;
            
            let headerClass = "status-wait";
            if(res.status === 'bull') headerClass = "status-bull";
            if(res.status === 'bear') headerClass = "status-bear";
            
            const title = res.title || "åˆ†æä¸­...";
            const content = res.html || "ç­‰å¾…é‹ç®—...";

            el.innerHTML = `
                <div class="advice-header ${headerClass}">
                    <span>${title}</span>
                </div>
                <div class="advice-content">${content}</div>
            `;
        }
        
        // --- æ¸²æŸ“ UI ---
        function updateTargetUI(symbol, buy, sell) {
            const b = document.getElementById(`buy-target-${symbol}`);
            const s = document.getElementById(`sell-target-${symbol}`);
            if(b) b.innerText = buy;
            if(s) s.innerText = sell;
        }
        function updateStrategyBadge(symbol, type) {
            const el = document.getElementById(`strat-badge-${symbol}`);
            if(!el) return;
            el.style.display = 'inline-block';
            if(type === 'VALUE') { el.className = 'strategy-badge strat-value'; el.innerText = 'ğŸ›¡ï¸ åƒ¹å€¼å­˜è‚¡'; }
            else if(type === 'TREND') { el.className = 'strategy-badge strat-trend'; el.innerText = 'ğŸš€ å¼·å‹¢è¶¨å‹¢'; }
            else { el.className = 'strategy-badge strat-swing'; el.innerText = 'ğŸ¢ æ³¢æ®µéœ‡ç›ª'; }
        }
        function render() {
            const grid = document.getElementById('portfolio-grid');
            grid.innerHTML = '';
            portfolio.forEach((s, idx) => {
                let tvSymbol = s.symbol.includes('.TW') ? 'TWSE:'+s.symbol.replace('.TW','') : s.symbol;
                const div = document.createElement('div');
                div.className = 'stock-card';
                div.innerHTML = `
                    <button class="del-btn" onclick="delStock(${idx})">âœ•</button>
                    <div class="card-header">
                        <div><div class="symbol">${s.symbol}</div><div style="font-size:0.9rem; color:var(--sub)">${s.name}</div><div id="strat-badge-${s.symbol}" class="strategy-badge" style="display:none"></div></div>
                        <div><div class="current-price" id="price-${s.symbol}">---</div></div>
                    </div>
                    <div class="target-section">
                        <div class="target-box box-buy"><div class="target-label">å»ºè­°è²·å…¥</div><div class="target-price" id="buy-target-${s.symbol}">---</div></div>
                        <div class="target-box box-sell"><div class="target-label">å»ºè­°è³£å‡º</div><div class="target-price" id="sell-target-${s.symbol}">---</div></div>
                    </div>
                    
                    <div id="advice-${s.symbol}" class="advice-container">
                        <div class="advice-header status-wait">ç­‰å¾…é‹ç®—...</div>
                    </div>

                    <div class="tv-analysis-container" id="tv-widget-${idx}"></div>
                    <div class="data-row" style="margin-top:10px;"><span style="color:var(--sub)">åº«å­˜ / å‡åƒ¹</span><span style="font-weight:bold; font-family:monospace;">${s.shares} è‚¡ @ $${(s.shares>0?s.cost/s.shares:0).toFixed(1)}</span></div>
                    <div class="pl-block">
                        <div><div style="font-size:0.8rem; color:var(--sub)">æç›Š</div><div class="pl-val" id="pl-val-${s.symbol}">---</div></div>
                        <div><div style="font-size:0.8rem; color:var(--sub)">å ±é…¬</div><div class="pl-pct" id="pl-pct-${s.symbol}">---</div></div>
                    </div>`;
                grid.appendChild(div);
                injectTvWidget(`tv-widget-${idx}`, tvSymbol);
            });
        }

        // åŸºæœ¬åŠŸèƒ½ (åŒä¸Šç‰ˆ)
        function updateCardPl(s) { const p = prices[s.symbol]||0; if(s.shares<=0 || p===0) return; const pf = (s.shares*p)-s.cost; const pct = (pf/s.cost)*100; const eV = document.getElementById(`pl-val-${s.symbol}`); const eP = document.getElementById(`pl-pct-${s.symbol}`); if(eV && eP) { eV.innerText=(pf>=0?'+':'')+Math.round(pf).toLocaleString(); eP.innerText=(pct>=0?'+':'')+pct.toFixed(2)+'%'; eV.className=pf>=0?'up':'down'; eP.className=pct>=0?'up':'down'; } }
        function injectTvWidget(id, sym) { const c = document.getElementById(id); if(!c) return; c.innerHTML=''; const s = document.createElement('script'); s.src = 'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js'; s.async = true; s.innerHTML = JSON.stringify({ "interval": "1D", "width": "100%", "height": "100%", "symbol": sym, "showIntervalTabs": true, "displayMode": "single", "locale": "zh_TW", "colorTheme": "dark", "isTransparent": true }); c.appendChild(s); }
        function updateAll() { const rate = parseFloat(document.getElementById('exchangeRate').value)||32.5; let usd=0, un=0; portfolio.forEach(s => { const p=prices[s.symbol]||0; if(s.shares>0&&p>0) { usd+=s.shares*p; un+=(s.shares*p)-s.cost; }}); document.getElementById('total-equity-twd').innerText = `NT$ ${Math.round(usd*rate).toLocaleString()}`; document.getElementById('total-equity-usd').innerText = `$${usd.toLocaleString(undefined,{maximumFractionDigits:2})}`; const uTwd = un*rate; document.getElementById('total-unrealized').innerText = (uTwd>=0?'+':'') + `NT$ ${Math.round(uTwd).toLocaleString()}`; document.getElementById('total-unrealized').className = `summary-val ${uTwd>=0?'up':'down'}`; }
        function openAddModal() { document.getElementById('addModal').style.display='flex'; }
        function confirmAdd() { const sym = document.getElementById('new-symbol').value.toUpperCase().trim(); if(sym) { portfolio.push({ symbol:sym, name:sym, shares:0, cost:0 }); saveDb(); render(); document.getElementById('addModal').style.display='none'; } }
        function delStock(i) { if(confirm("åˆªé™¤?")) { portfolio.splice(i,1); saveDb(); render(); } }
    </script>
</body>
</html>