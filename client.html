<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ¶è³‡æ–™ç®¡ç†ç³»çµ± (éœé»˜å„²å­˜ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --line-color: #00c300;
        }

        body {
            font-family: "Microsoft JhengHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
        }

        /* è¼¸å…¥å€å¡Š */
        .input-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border-left: 5px solid var(--accent-color);
        }

        .edit-mode-indicator {
            display: none;
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border: 1px solid #ffeeba;
            text-align: center;
            font-weight: bold;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .full-width { grid-column: span 4; }
        .half-width { grid-column: span 2; }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }

        input[type="date"] { background-color: #fcfcfc; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        button {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.3s;
        }
        button:hover { opacity: 0.9; }

        .btn-save { background-color: var(--accent-color); font-weight: bold; }
        .btn-export { background-color: #27ae60; }
        .btn-import { background-color: #8e44ad; }
        .btn-cancel { background-color: #95a5a6; display: none; }
        
        /* è¡¨æ ¼å…§çš„æ“ä½œæŒ‰éˆ• */
        .action-btns {
            display: flex;
            gap: 5px;
            justify-content: flex-start;
        }

        .btn-delete {
            background-color: #e74c3c;
            padding: 6px 12px;
            font-size: 14px;
            white-space: nowrap;
        }

        .btn-edit {
            background-color: #f39c12;
            padding: 6px 12px;
            font-size: 14px;
            white-space: nowrap;
            margin-right: 0; /* reset margin */
        }

        .search-section { margin-bottom: 20px; }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            font-size: 16px;
        }

        .import-section {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            white-space: nowrap;
        }

        tr:hover { background-color: #f1f1f1; }
        .line-id-text { color: var(--line-color); font-weight: bold; }
        .no-data { text-align: center; color: #777; padding: 20px; }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .full-width, .half-width { grid-column: span 1; }
            .import-section { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>å®¢æˆ¶è³‡æ–™ç®¡ç†ç³»çµ±</h1>

    <div class="input-card" id="formCard">
        <div id="editModeMsg" class="edit-mode-indicator">âš ï¸ æ­£è™•æ–¼ç·¨è¼¯æ¨¡å¼</div>
        <input type="hidden" id="editId" value="">

        <div class="form-grid">
            <div>
                <label>ç´€éŒ„æ—¥æœŸ (å¿…å¡«)</label>
                <input type="date" id="recordDate">
            </div>
            <div>
                <label>å§“å (å¿…å¡«)</label>
                <input type="text" id="name" placeholder="è¼¸å…¥å§“å">
            </div>
            <div>
                <label>é›»è©± (å¿…å¡«)</label>
                <input type="tel" id="phone" placeholder="è¼¸å…¥é›»è©±">
            </div>
            <div>
                <label>Line ID</label>
                <input type="text" id="lineId" placeholder="è¼¸å…¥ Line ID">
            </div>
            <div class="full-width">
                <label>åœ°å€</label>
                <input type="text" id="address" placeholder="è¼¸å…¥åœ°å€">
            </div>
            <div class="half-width">
                <label>å·¥ä½œç¶“æ­·</label>
                <textarea id="experience" rows="2" placeholder="ç°¡è¿°å·¥ä½œç¶“æ­·"></textarea>
            </div>
            <div class="half-width">
                <label>è¯çµ¡å…§å®¹ / å‚™è¨»</label>
                <textarea id="notes" rows="2" placeholder="è¨˜éŒ„è¯çµ¡äº‹é …..."></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="saveData()" id="saveBtn" class="btn-save">å„²å­˜è³‡æ–™</button>
            <button onclick="cancelEdit()" id="cancelBtn" class="btn-cancel">å–æ¶ˆç·¨è¼¯</button>
            <button onclick="exportData()" class="btn-export">åŒ¯å‡º Excel (CSV)</button>
        </div>

        <div class="import-section">
            <span style="font-size: 14px; font-weight: bold;">åŒ¯å…¥è³‡æ–™ï¼š</span>
            <input type="file" id="csvFileInput" accept=".csv">
            <button onclick="importCSV()" class="btn-import">ç¢ºèªåŒ¯å…¥</button>
        </div>
    </div>

    <div class="search-section">
        <input type="text" id="searchInput" class="search-input" placeholder="ğŸ” æœå°‹å§“åã€é›»è©±ã€Line ID..." onkeyup="searchData()">
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th width="10%">æ—¥æœŸ</th>
                    <th width="10%">å§“å</th>
                    <th width="12%">é›»è©±</th>
                    <th width="10%">Line ID</th>
                    <th width="20%">åœ°å€</th>
                    <th width="15%">å·¥ä½œç¶“æ­·</th>
                    <th width="13%">è¯çµ¡å…§å®¹</th>
                    <th width="140px">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div id="noDataMsg" class="no-data">ç›®å‰æ²’æœ‰è³‡æ–™</div>
    </div>
</div>

<script>
    function setTodayDate() {
        const dateField = document.getElementById('recordDate');
        if (dateField) {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateField.value = `${year}-${month}-${day}`;
        }
    }

    window.onload = function() {
        try {
            loadData();
            setTodayDate();
        } catch (e) { console.error("åˆå§‹åŒ–éŒ¯èª¤:", e); }
    };

    function saveData() {
        try {
            const editIdField = document.getElementById('editId');
            const recordDateField = document.getElementById('recordDate');
            const nameField = document.getElementById('name');
            const phoneField = document.getElementById('phone');
            
            if (!editIdField || !recordDateField || !nameField || !phoneField) {
                alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚");
                return;
            }

            if (!recordDateField.value) setTodayDate();

            const editId = editIdField.value;
            const recordDate = recordDateField.value;
            const name = nameField.value.trim();
            const phone = phoneField.value.trim();
            const lineId = document.getElementById('lineId').value.trim();
            const address = document.getElementById('address').value.trim();
            const experience = document.getElementById('experience').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (!name || !phone) {
                alert('è«‹è‡³å°‘å¡«å¯«ã€Œå§“åã€èˆ‡ã€Œé›»è©±ã€ï¼');
                return;
            }

            let records = JSON.parse(localStorage.getItem('contactRecords')) || [];

            if (editId) {
                const index = records.findIndex(r => r.id == editId);
                if (index !== -1) {
                    records[index] = { ...records[index], recordDate, name, phone, lineId, address, experience, notes };
                    // ç§»é™¤æˆåŠŸæç¤ºï¼šalert('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
                }
            } else {
                const newRecord = {
                    id: Date.now(),
                    createdDate: new Date().toLocaleString(),
                    recordDate, name, phone, lineId, address, experience, notes
                };
                records.push(newRecord);
                // ç§»é™¤æˆåŠŸæç¤ºï¼šalert('è³‡æ–™å„²å­˜æˆåŠŸï¼');
            }

            localStorage.setItem('contactRecords', JSON.stringify(records));
            resetForm();
            loadData();

        } catch (error) {
            alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
        }
    }

    function resetForm() {
        document.getElementById('editId').value = '';
        document.getElementById('name').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('lineId').value = '';
        document.getElementById('address').value = '';
        document.getElementById('experience').value = '';
        document.getElementById('notes').value = '';
        setTodayDate();

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerText = "å„²å­˜è³‡æ–™";
        saveBtn.style.backgroundColor = ""; 
        document.getElementById('cancelBtn').style.display = "none";
        document.getElementById('editModeMsg').style.display = "none";
    }

    function editData(id) {
        let records = JSON.parse(localStorage.getItem('contactRecords')) || [];
        const record = records.find(r => r.id == id);
        if (!record) return;

        document.getElementById('editId').value = record.id;
        document.getElementById('recordDate').value = record.recordDate || '';
        document.getElementById('name').value = record.name;
        document.getElementById('phone').value = record.phone;
        document.getElementById('lineId').value = record.lineId || '';
        document.getElementById('address').value = record.address;
        document.getElementById('experience').value = record.experience;
        document.getElementById('notes').value = record.notes;

        const saveBtn = document.getElementById('saveBtn');
        saveBtn.innerText = "æ›´æ–°è³‡æ–™";
        saveBtn.style.backgroundColor = "#f39c12"; 
        document.getElementById('cancelBtn').style.display = "inline-block";
        document.getElementById('editModeMsg').style.display = "block";
        
        document.getElementById('formCard').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() { resetForm(); }

    function deleteData(id) {
        // åˆªé™¤é€šå¸¸é‚„æ˜¯å»ºè­°ä¿ç•™ç¢ºèªæ¡†ï¼Œé¿å…èª¤åˆª
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) {
            let records = JSON.parse(localStorage.getItem('contactRecords')) || [];
            records = records.filter(record => record.id !== id);
            localStorage.setItem('contactRecords', JSON.stringify(records));
            if(document.getElementById('editId').value == id) cancelEdit();
            
            const searchVal = document.getElementById('searchInput').value;
            if(searchVal) searchData(); else loadData();
        }
    }

    function loadData() {
        let records = JSON.parse(localStorage.getItem('contactRecords')) || [];
        renderTable(records);
    }

    function renderTable(data) {
        const tbody = document.getElementById('tableBody');
        const noDataMsg = document.getElementById('noDataMsg');
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
            noDataMsg.style.display = 'block';
            return;
        } else {
            noDataMsg.style.display = 'none';
        }

        data.sort((a, b) => {
            const dateA = a.recordDate ? new Date(a.recordDate) : new Date(0);
            const dateB = b.recordDate ? new Date(b.recordDate) : new Date(0);
            return dateB - dateA;
        });

        data.forEach(record => {
            const displayDate = record.recordDate || '';
            const displayLine = record.lineId ? `<span class="line-id-text">${record.lineId}</span>` : '';

            const row = `
                <tr>
                    <td>${displayDate}</td>
                    <td><strong>${record.name}</strong></td>
                    <td>${record.phone}</td>
                    <td>${displayLine}</td>
                    <td>${record.address}</td>
                    <td>${record.experience}</td>
                    <td>${record.notes}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-edit" onclick="editData(${record.id})">ç·¨è¼¯</button>
                            <button class="btn-delete" onclick="deleteData(${record.id})">åˆªé™¤</button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function searchData() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        let records = JSON.parse(localStorage.getItem('contactRecords')) || [];

        const filtered = records.filter(r => {
            const line = r.lineId ? r.lineId.toLowerCase() : '';
            return (
                r.name.toLowerCase().includes(keyword) ||
                r.phone.includes(keyword) ||
                line.includes(keyword) ||
                (r.address && r.address.toLowerCase().includes(keyword)) ||
                (r.notes && r.notes.toLowerCase().includes(keyword))
            );
        });
        renderTable(filtered);
    }

    function exportData() {
        let records = JSON.parse(localStorage.getItem('contactRecords')) || [];
        if(records.length === 0) {
            alert("æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º");
            return;
        }
        let csvContent = "\uFEFF"; 
        csvContent += "æ—¥æœŸ,å§“å,é›»è©±,LineID,åœ°å€,å·¥ä½œç¶“æ­·,è¯çµ¡å…§å®¹\n";

        records.forEach(row => {
            const clean = text => text ? text.replace(/,/g, "ï¼Œ").replace(/\n/g, " ") : "";
            const line = `${row.recordDate || ''},${clean(row.name)},${clean(row.phone)},${clean(row.lineId)},${clean(row.address)},${clean(row.experience)},${clean(row.notes)}`;
            csvContent += line + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.href = url;
        link.download = `å®¢æˆ¶è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function importCSV() {
        const fileInput = document.getElementById('csvFileInput');
        const file = fileInput.files[0];
        if (!file) { alert("è«‹å…ˆé¸æ“‡ CSV æª”æ¡ˆ"); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split('\n');
                let records = JSON.parse(localStorage.getItem('contactRecords')) || [];
                let count = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const cols = line.split(',');
                    if (cols.length >= 3) {
                        records.push({
                            id: Date.now() + i,
                            createdDate: new Date().toLocaleString(),
                            recordDate: cols[0].trim(),
                            name: cols[1].trim(),
                            phone: cols[2].trim(),
                            lineId: cols[3] ? cols[3].trim() : "",
                            address: cols[4] ? cols[4].trim() : "",
                            experience: cols[5] ? cols[5].trim() : "",
                            notes: cols[6] ? cols[6].trim() : ""
                        });
                        count++;
                    }
                }
                localStorage.setItem('contactRecords', JSON.stringify(records));
                loadData();
                alert(`åŒ¯å…¥æˆåŠŸï¼æ–°å¢äº† ${count} ç­†è³‡æ–™ã€‚`);
                fileInput.value = '';
            } catch (err) {
                alert("åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚");
            }
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>