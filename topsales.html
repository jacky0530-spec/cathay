<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å·é«˜å³°æœƒæ¥­ç¸¾æ’å & A&Hçé‡‘æ˜ç´°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ä¹å·/æ—¥æœ¬é¢¨æ ¼é…è‰² */
        :root {
            --jp-indigo: #1a237e;
            --jp-red: #b71c1c;
            --jp-sakura: #fce4ec;
            --jp-gold: #ffd700;
            --jp-bg: #fffbf0;
            --jp-text: #2c3e50;
            
            --col-excl-bg: #e8eaf6;
            --col-excl-text: #1a237e;
            
            /* é’è‰²ç³»ï¼šç´¯è¨ˆæ¥­ç¸¾ */
            --col-incl-bg: #e0f7fa; 
            --col-incl-text: #006064; 
            --col-incl-border: #0097a7; 
            
            /* ç´…è‰²ç³»ï¼šA&H çé‡‘ */
            --col-bonus-bg: #ffebee; 
            --col-bonus-text: #d50000; 
        }

        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", "Noto Sans JP", sans-serif; 
            margin: 0; 
            padding: 20px;
            background-color: var(--jp-bg); 
            color: var(--jp-text);
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container { 
            width: 100%; 
            max-width: 1280px; 
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95); 
            padding: 20px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.1); 
            border-radius: 15px; 
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }

        .container::before {
            content: "ğŸŒ¸";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 150px;
            opacity: 0.1;
            z-index: 0;
            transform: rotate(20deg);
        }
        
        .header-section { 
            text-align: center; 
            margin-bottom: 20px; 
            position: relative;
            z-index: 1;
        }
        
        .controls { 
            background: white; 
            padding: 15px 30px; 
            border-radius: 50px; 
            border: 2px solid var(--jp-indigo); 
            margin-bottom: 25px; 
            display: inline-block; 
            min-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        h1 { 
            text-align: center; 
            color: var(--jp-indigo); 
            margin-top: 5px; 
            margin-bottom: 15px; 
            letter-spacing: 2px; 
            font-size: 2em;
            font-weight: 900;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .kyushu-icon { font-size: 1.5em; vertical-align: middle; margin: 0 5px; }
        
        .btn-box { font-size: 16px; font-weight: bold; color: var(--jp-indigo); }
        input[type="file"] { margin-left: 10px; }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            font-size: 14px; 
            background-color: white;
        }
        
        th, td { 
            border-bottom: 1px solid #ddd; 
            border-right: 1px solid #ddd; 
            padding: 6px 4px; 
            text-align: right; 
            white-space: nowrap; 
            vertical-align: middle; 
        }
        
        th { 
            background-color: var(--jp-indigo); 
            color: white; 
            text-align: center; 
            font-weight: bold; 
            position: sticky; 
            top: 0; 
            z-index: 2; 
            border-right: 1px solid #3949ab;
        }
        
        td:last-child, th:last-child { border-right: none; }
        
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f4c3; transition: background 0.3s; }

        .col-total-excl { background-color: var(--col-excl-bg); color: var(--col-excl-text); font-weight: bold; border-left: 2px solid var(--col-excl-text); }
        .col-ah-fyp { font-weight: bold; color: #333; }
        
        /* ç´¯è¨ˆæ¥­ç¸¾ (å«åŠ è¨ˆ) */
        .col-total-incl { 
            background-color: var(--col-incl-bg); 
            color: var(--col-incl-text); 
            font-weight: 900; 
            font-size: 1.2em;
            border-left: 2px solid var(--col-incl-border); 
        }

        /* çé‡‘ */
        .col-bonus { 
            color: var(--col-bonus-text); 
            font-weight: 900; 
            font-size: 1.1em;
            background-color: var(--col-bonus-bg);
        }
        .col-bonus-pending {
            color: #e65100;
            font-weight: bold;
            font-size: 1em;
            background-color: #fff3e0;
        }

        .cell-innovation-pass {
            background-color: #f3e5f5 !important;
            color: #4a148c;
            font-weight: bold;
            border: 2px solid #ce93d8;
            position: relative;
        }

        /* æ’åé†’ç›® (Top 1350) */
        .cell-rank-top {
            background-color: #ffccbc !important;
            color: #bf360c;
            font-weight: 900;
            border: 2px solid #ff7043;
            font-size: 1.8em; 
            text-align: center;
            vertical-align: middle;
        }
        .rank-badge {
            display: inline-block;
            background: #d84315;
            color: white;
            font-size: 0.5em;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 5px;
            vertical-align: middle;
            position: relative;
            top: -2px;
        }

        .trophy-icon { display: inline-block; margin-left: 5px; font-size: 1.1em; }

        tr.row-winner { background-color: #fff9c4 !important; }
        
        .col-rank { 
            text-align: center; 
            font-weight: bold; 
            color: #555; 
            background-color: rgba(0,0,0,0.02); 
            font-size: 1.5em; 
        }
        
        .col-name { 
            text-align: center; 
            min-width: 100px; 
            font-weight: 900; 
            font-size: 1.8em; 
            color: #1a237e; 
            text-shadow: 1px 1px 0px rgba(0,0,0,0.05);
            letter-spacing: 1px;
        }
        
        .status-pass { 
            color: #2e7d32; 
            font-weight: bold; 
            border: 1px solid #2e7d32; 
            padding: 2px 8px; 
            border-radius: 12px; 
            background: #e8f5e9; 
            display: inline-block;
        }
        .status-fail { color: #c62828; font-weight: bold; font-size: 0.9em; } 
        .status-diff { color: #d84315; font-size: 0.85em; display: block; margin-top: 2px; }
        .status-none { color: #bdbdbd; font-size: 0.8em; }
        
        #statusMsg { font-weight: bold; display: block; margin-top: 5px; }
        .debug-box { display: none; }
        
        .footer-deco {
            text-align: center;
            margin-top: 20px;
            font-size: 20px;
            color: #ccc;
        }
        
        /* å°æ¨™é¡Œå­—é«” */
        th small { opacity: 0.8; font-weight: normal; display: block; margin-top: 2px;}
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <div class="controls">
            <div class="btn-box">
                ğŸ“‚ ä¸Šå‚³æª”æ¡ˆï¼š
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
            </div>
            <div id="statusMsg" style="color: var(--jp-indigo);">è«‹é¸æ“‡ã€Œé«˜å³°æœƒæ¥­ç¸¾é€Ÿå ±.xlsxã€...</div>
        </div>
    </div>

    <h1>
        <span class="kyushu-icon">ğŸŒ‹</span> ä¹å·é«˜å³°æœƒ <span class="kyushu-icon">â™¨ï¸</span> æ¥­ç¸¾æ’å & A&Hçé‡‘æ˜ç´°
    </h1>

    <div id="debugLog" class="debug-box"></div>
    
    <div class="table-wrapper">
        <div id="output"></div>
    </div>
    
    <div class="footer-deco">
        ğŸŒŠ ğŸ¯ ğŸš„ ğŸœ ğŸŒ¸
    </div>
</div>

<script>
    const logBox = document.getElementById('debugLog');
    const statusMsg = document.getElementById('statusMsg');

    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        this.value = '';

        document.getElementById('output').innerHTML = '';
        statusMsg.innerText = "â³ æ­£åœ¨è®€å–æ•¸æ“š...";
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const firstSheetName = workbook.SheetNames[0];
                const ws = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});

                if (!rows || rows.length < 2) {
                    statusMsg.innerText = "âŒ ç¬¬ä¸€å¼µå·¥ä½œè¡¨æ²’æœ‰æ•¸æ“š";
                    statusMsg.style.color = "#d32f2f";
                    return;
                }

                let colMap = {};
                let totalCols = [];
                let dataStartRow = 0;

                for (let r = 0; r < Math.min(rows.length, 20); r++) {
                    const row = rows[r];
                    if (!Array.isArray(row)) continue;
                    row.forEach((cell, idx) => {
                        if (typeof cell !== 'string') return;
                        const c = cell.trim();
                        
                        if (c === 'åºè™Ÿ') colMap['Rank'] = idx;
                        else if (c.includes('ä»£è™Ÿ')) colMap['ID'] = idx;
                        else if (c.includes('å§“å')) colMap['Name'] = idx;
                        else if (c.includes('12å·¥æ¥­ç¸¾')) colMap['M12'] = idx;
                        else if (c.includes('13å·¥æ¥­ç¸¾')) colMap['M13'] = idx;
                        else if (c.includes('1å·¥æ¥­ç¸¾')) colMap['M1'] = idx;
                        else if (c.includes('2å·¥æ¥­ç¸¾')) colMap['M2'] = idx;
                        else if (c.includes('3å·¥æ¥­ç¸¾')) colMap['M3'] = idx;
                        else if (c.includes('ç‰¹å®šå•†å“')) colMap['Specific'] = idx;
                        else if (c.includes('13å·¥è²¬ä»»é¡')) colMap['Quota'] = idx;
                        else if (c.includes('è­‰åˆ¸æ‰£é™¤')) colMap['Deduct'] = idx;
                        else if (c.includes('A&H') && c.includes('FYP')) colMap['AH'] = idx;
                        else if (c.includes('ç´¯è¨ˆæ¥­ç¸¾') && c.includes('FYP')) {
                            totalCols.push(idx);
                        }
                    });
                }

                if (totalCols.length > 0) {
                    totalCols.sort((a, b) => a - b);
                    colMap['Total_Excl'] = totalCols[0];
                    colMap['Total_Incl'] = totalCols.length > 1 ? totalCols[totalCols.length - 1] : totalCols[0];
                }

                if (colMap['AH'] === undefined || colMap['Rank'] === undefined) {
                    statusMsg.innerText = "âŒ æ‰¾ä¸åˆ°ç¬¦åˆæ ¼å¼çš„è³‡æ–™ (éœ€åŒ…å«åºè™Ÿã€A&Hæ¥­ç¸¾)";
                    statusMsg.style.color = "#d32f2f";
                    return;
                }

                for(let k=0; k<30; k++) {
                    const testRow = rows[k];
                    if(testRow && testRow[colMap['Rank']] && !isNaN(parseFloat(testRow[colMap['Rank']]))) {
                        dataStartRow = k;
                        break;
                    }
                }
                if(dataStartRow === 0) dataStartRow = 5;

                statusMsg.innerText = "âœ… è¨ˆç®—å®Œæˆï¼";
                statusMsg.style.color = "#2e7d32";
                renderTable(rows, dataStartRow, colMap);

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "âŒ ç¨‹å¼éŒ¯èª¤: " + err.message;
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function cleanNum(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        let s = val.toString().replace(/,/g, '').trim();
        if (s === '--' || s === '') return 0;
        let num = parseFloat(s);
        return isNaN(num) ? 0 : num;
    }

    // æ ¼å¼åŒ–ç‚ºã€Œè¬ã€å–®ä½ï¼Œæœ€å¤§2ä½å°æ•¸ (ç”¨æ–¼æ¥­ç¸¾)
    function fmtWan(n) {
        if (n === 0 || isNaN(n)) return '0';
        return (n / 10000).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    // æ ¼å¼åŒ–ç‚ºåŸå§‹æ•´æ•¸ (ç”¨æ–¼A&Hçé‡‘)
    function fmtRaw(n) {
        if (n === 0 || isNaN(n)) return '0';
        return n.toLocaleString('zh-TW');
    }

    function renderTable(rows, startIdx, colMap) {
        const getVal = (row, key) => colMap[key] !== undefined ? cleanNum(row[colMap[key]]) : 0;
        const getRaw = (row, key) => colMap[key] !== undefined ? (row[colMap[key]] || '') : '';

        // è¡¨é ­ï¼šA&Hçé‡‘ç§»é™¤äº†(è¬)
        let html = `<table>
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>å§“å</th>
                    <th>12å·¥<small>(è¬)</small></th>
                    <th>13å·¥<small>(è¬)</small></th>
                    <th>1å·¥<small>(è¬)</small></th>
                    <th>2å·¥<small>(è¬)</small></th>
                    <th>3å·¥<small>(è¬)</small></th>
                    <th style="background:var(--col-excl-bg); color:var(--col-excl-text);">ç´¯è¨ˆæ¥­ç¸¾<small>(ä¸å«åŠ è¨ˆ/è¬)</small></th>
                    <th>A&H<small>(è¬)</small></th>
                    <th>ç‰¹å®š<small>(è¬)</small></th>
                    <th style="background:var(--col-incl-bg); color:var(--col-incl-text); font-size:1.1em;">ç´¯è¨ˆæ¥­ç¸¾<small>(å«åŠ è¨ˆ/è¬)</small></th>
                    <th style="background:var(--col-bonus-bg); color:var(--col-bonus-text);">A&Hçé‡‘</th>
                    <th>ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody>`;

        const P_UNIT = 10000;
        const specialIds = ['EL13016', 'EL13015', 'EL130AE'];
        
        let count = 0;

        for(let i = startIdx; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            const rankRaw = getRaw(row, 'Rank');
            const rank = parseFloat(rankRaw);
            const idRaw = getRaw(row, 'ID');
            const id = String(idRaw).trim();
            const name = getRaw(row, 'Name');
            
            if (!rankRaw && !id) continue;

            const m12 = getVal(row, 'M12');
            const m13 = getVal(row, 'M13');
            const m1 = getVal(row, 'M1');
            const m2 = getVal(row, 'M2');
            const m3 = getVal(row, 'M3');
            
            const ahFyp = getVal(row, 'AH');
            const specific = getVal(row, 'Specific');
            const totalExcl = getVal(row, 'Total_Excl');
            const totalIncl = getVal(row, 'Total_Incl');
            const quota = getVal(row, 'Quota');
            const deduct = getVal(row, 'Deduct');

            const adjTotal = totalExcl - deduct;
            const target = (100 * P_UNIT) + quota;
            const passTotal = adjTotal >= target;
            
            const passAh = ahFyp >= (24 * P_UNIT);
            let potentialBonus = 0;
            if (passAh) {
                const excess = ahFyp - (24 * P_UNIT);
                if (excess >= P_UNIT) {
                    const pCount = Math.floor(excess / P_UNIT);
                    let rate = 0;
                    if (pCount >= 1 && pCount < 25) rate = 800;
                    else if (pCount >= 25 && pCount < 100) rate = 1000;
                    else if (pCount >= 100) rate = 1200;
                    potentialBonus = pCount * rate;
                }
            }

            const eligible = passTotal && passAh;
            
            let statusHtml = '<span class="status-none">-</span>';
            let rowClass = '';
            let bonusClass = 'col-bonus'; 
            
            if (eligible) {
                statusHtml = '<span class="status-pass">é”æ¨™</span>';
                if (potentialBonus > 0) {
                    rowClass = 'row-winner';
                }
            } else {
                if (!passTotal) {
                    const deficit = target - adjTotal;
                    // å·®é¡ç¶­æŒ (è¬)
                    const deficitWan = (deficit / 10000).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    statusHtml = `<span class="status-fail">æœªé”æ¨™</span><br><span class="status-diff">(å·® ${deficitWan} è¬)</span>`;
                    
                    if (potentialBonus > 0) {
                        bonusClass = 'col-bonus-pending';
                    }
                } else if (!passAh) {
                    statusHtml = '<span class="status-none">æœªé”æ¨™</span>';
                }
            }
            
            // çé‡‘é¡¯ç¤ºï¼šä½¿ç”¨åŸå§‹æ•´æ•¸
            const bonusHtml = potentialBonus > 0 ? `$${fmtRaw(potentialBonus)}` : '0';

            let innovationThreshold = 40 * 10000; 
            if (specialIds.includes(id)) {
                innovationThreshold = 25 * 10000;
            }

            function getMonthCell(val) {
                if (val >= innovationThreshold) {
                    // å–®æœˆæ¥­ç¸¾ï¼šä½¿ç”¨ (è¬)
                    return `<td class="cell-innovation-pass">${fmtWan(val)} <span class="trophy-icon">ğŸ†</span></td>`;
                } else {
                    return `<td>${fmtWan(val)}</td>`;
                }
            }

            let rankHtml = rankRaw;
            let rankClass = "col-rank";
            if (!isNaN(rank) && rank <= 1350) {
                rankClass = "cell-rank-top";
                rankHtml = `<span class="rank-badge">Top</span>${rankRaw}`;
            }

            count++;

            // æ¥­ç¸¾æ•¸å€¼æ¬„ä½ï¼šä½¿ç”¨ fmtWan (è¬)
            html += `<tr class="${rowClass}">
                <td class="${rankClass}">${rankHtml}</td>
                <td class="col-name">${name}</td>
                <td>${fmtWan(m12)}</td>
                ${getMonthCell(m13)}
                ${getMonthCell(m1)}
                ${getMonthCell(m2)}
                ${getMonthCell(m3)}
                <td class="col-total-excl">${fmtWan(totalExcl)}</td>
                <td class="col-ah-fyp">${fmtWan(ahFyp)}</td>
                <td>${fmtWan(specific)}</td>
                <td class="col-total-incl">${fmtWan(totalIncl)}</td>
                <td class="${bonusClass}">${bonusHtml}</td>
                <td>${statusHtml}</td>
            </tr>`;
        }

        html += '</tbody></table>';
        
        if(count === 0) {
            html = '<div style="padding:40px; text-align:center; color:#888;">âš ï¸ æ²’æœ‰è®€å–åˆ°æ•¸æ“šã€‚</div>';
        }

        document.getElementById('output').innerHTML = html;
    }
</script>

</body>
</html>