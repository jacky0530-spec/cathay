<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹å·é«˜å³°æœƒæ¥­ç¸¾æ’å & A&Hçé‡‘æ˜ç´°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- åŸºç¤é…è‰² --- */
        :root {
            --jp-indigo: #1a237e;
            --jp-red: #b71c1c;
            --jp-sakura: #fce4ec;
            --jp-gold: #ffd700;
            --jp-bg: #fffbf0;
            --jp-text: #2c3e50;
            
            /* æˆ°å ±çœ‹æ¿é…è‰² */
            --db-header-bg: #0d2e53;
            --db-highlight: #d32f2f;
            
            /* è¡¨æ ¼é…è‰² */
            --col-excl-bg: #e8eaf6;
            --col-excl-text: #1a237e;
            --col-incl-bg: #e0f7fa;
            --col-incl-text: #006064;
            --col-incl-border: #0097a7;
            --col-bonus-bg: #ffebee;
            --col-bonus-text: #d50000;
        }

        body { 
            font-family: "Microsoft JhengHei", "Heiti TC", "Noto Sans JP", sans-serif; 
            margin: 0; 
            padding: 10px;
            background-color: var(--jp-bg); 
            color: var(--jp-text);
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .container { 
            width: 100%; 
            max-width: 1280px; 
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95); 
            padding: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1); 
            border-radius: 15px; 
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
        }

        .container::before {
            content: "ğŸŒ¸";
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 150px;
            opacity: 0.1;
            z-index: 0;
            transform: rotate(20deg);
        }

        /* --- é ‚éƒ¨ä¸Šå‚³å€ --- */
        .top-upload-section {
            background: white;
            padding: 10px;
            border-radius: 50px;
            border: 2px solid var(--jp-indigo);
            margin-bottom: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            position: relative;
            z-index: 5;
        }

        .btn-box { font-size: 15px; font-weight: bold; color: var(--jp-indigo); }
        input[type="file"] { margin-left: 10px; font-size: 13px; }
        #statusMsg { font-weight: bold; display: inline-block; margin-left: 10px; color: #555; font-size: 0.9em; }

        h1 { 
            text-align: center; 
            color: var(--jp-indigo); 
            margin-top: 0; 
            margin-bottom: 15px; 
            letter-spacing: 1px; 
            font-size: 1.8em;
            font-weight: 900;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        .kyushu-icon { font-size: 1.4em; vertical-align: middle; margin: 0 5px; }

        /* --- æˆ°å ±çœ‹æ¿ --- */
        .dashboard-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #fff9c4 0%, #fff 100%);
            border: 2px solid #fbc02d;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 2;
        }

        .dash-content {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center;
            gap: 30px;
            width: 100%;
        }

        .dash-table-container {
            flex: 1;
            max-width: 600px;
            min-width: 280px;
        }

        .dash-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.1em;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #0d2e53;
        }

        .dash-table th {
            background-color: var(--db-header-bg);
            color: white;
            padding: 8px;
            font-size: 1.1em;
            text-align: center;
            letter-spacing: 1px;
        }

        .dash-table td {
            padding: 6px 10px;
            text-align: center;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
        }

        .dash-table tr:last-child td { border-bottom: none; }
        
        .dash-input {
            width: 80px;
            padding: 4px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: #333;
        }
        
        .val-highlight { color: var(--db-highlight); font-size: 1.2em; font-weight: 900; }
        .row-rank-name { text-align: left !important; color: #000; font-weight: 800; font-size: 1em; }
        .rank-label { font-size: 0.9em; color: #555; }

        /* å€’æ•¸æ—¥æ›† */
        .countdown-container {
            flex: 0 0 auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform: scale(1.3);
            margin: 0 20px;
        }

        .countdown-label {
            font-size: 1.3em;
            font-weight: 900;
            color: #000;
            margin-bottom: 5px;
            text-shadow: 1px 1px 0 white;
        }

        .calendar-icon {
            background: white;
            border-radius: 12px;
            border: 1px solid #ccc;
            width: 110px; 
            position: relative;
            padding-bottom: 8px;
            animation: pulse-glow 2s infinite ease-in-out;
        }

        @keyframes pulse-glow {
            0% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(211, 47, 47, 0.6); border-color: #d32f2f; }
            100% { transform: scale(1); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        }

        .calendar-top {
            background: #d32f2f;
            height: 22px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .calendar-top::before, .calendar-top::after {
            content: "";
            position: absolute;
            top: -6px;
            width: 7px;
            height: 18px;
            background: #555;
            border-radius: 3px;
            border: 1px solid #333;
        }
        .calendar-top::before { left: 20px; }
        .calendar-top::after { right: 20px; }

        .calendar-input {
            width: 80%;
            border: none;
            font-size: 3.2em;
            font-weight: 900;
            color: #d32f2f;
            text-align: center;
            margin-top: 8px;
            outline: none;
            background: transparent;
        }

        @media (max-width: 850px) {
            .dash-content { flex-wrap: wrap; }
            .dash-table-container { min-width: 100%; order: 2; }
            .countdown-container { width: 100%; order: 1; margin-bottom: 20px; transform: scale(1.1); }
        }

        /* --- ä¸»è¡¨æ ¼ --- */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 0; 
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            font-size: 14px; 
            background-color: white;
        }
        
        th, td { 
            border-bottom: 1px solid #ddd; 
            border-right: 1px solid #ddd; 
            padding: 6px 4px; 
            text-align: right; 
            white-space: nowrap; 
            vertical-align: middle; 
        }
        
        th { 
            background-color: var(--jp-indigo); 
            color: white; 
            text-align: center; 
            font-weight: bold; 
            position: sticky; 
            top: 0; 
            z-index: 2; 
            border-right: 1px solid #3949ab;
        }
        
        td:last-child, th:last-child { border-right: none; }
        tr:nth-child(even) { background-color: #fafafa; }
        tr:hover { background-color: #f0f4c3; transition: background 0.3s; }

        /* é€šç”¨é«˜äº®æ¬„ä½ */
        .col-data-highlight { font-weight: 900; color: #000; }

        /* ç‰¹æ®Šæ¬„ä½ */
        .col-total-excl { background-color: var(--col-excl-bg); color: #1a237e; font-weight: 900; border-left: 2px solid var(--col-excl-text); }
        .col-ah-fyp { font-weight: 900; color: #000; }
        .col-total-incl { background-color: var(--col-incl-bg); color: var(--col-incl-text); font-weight: 900; font-size: 1.2em; border-left: 2px solid var(--col-incl-border); }
        .col-bonus { color: var(--col-bonus-text); font-weight: 900; font-size: 1.1em; background-color: var(--col-bonus-bg); }
        .col-bonus-pending { color: #e65100; font-weight: bold; font-size: 1em; background-color: #fff3e0; }

        .cell-innovation-pass { background-color: #f3e5f5 !important; color: #4a148c; font-weight: 900; border: 2px solid #ce93d8; position: relative; }

        /* æ’åèˆ‡å§“å */
        .cell-rank-top { background-color: #ffccbc !important; color: #bf360c; font-weight: 900; border: 2px solid #ff7043; font-size: 1.8em; text-align: center; vertical-align: middle; }
        .rank-badge { display: inline-block; background: #d84315; color: white; font-size: 0.5em; padding: 2px 6px; border-radius: 10px; margin-right: 5px; vertical-align: middle; position: relative; top: -2px; }
        .trophy-icon { display: inline-block; margin-left: 5px; font-size: 1.1em; }
        tr.row-winner { background-color: #fff9c4 !important; }
        .col-rank { text-align: center; font-weight: bold; color: #555; background-color: rgba(0,0,0,0.02); font-size: 1.5em; }
        .col-name { text-align: center; min-width: 100px; font-weight: 900; font-size: 1.8em; color: #1a237e; text-shadow: 1px 1px 0px rgba(0,0,0,0.05); letter-spacing: 1px; }
        
        .status-pass { color: #2e7d32; font-weight: bold; border: 1px solid #2e7d32; padding: 2px 8px; border-radius: 12px; background: #e8f5e9; display: inline-block; }
        .status-fail { color: #c62828; font-weight: bold; font-size: 0.9em; } 
        .status-diff { color: #d84315; font-size: 0.85em; display: block; margin-top: 2px; }
        .status-diff-ka { color: #0277bd; font-size: 0.85em; display: block; margin-top: 1px; font-weight: bold; }
        .status-none { color: #bdbdbd; font-size: 0.8em; }
        
        /* ç¹¼çºŒç‡è­¦ç¤ºå­— - ã€ä¿®æ­£ã€‘å­—é«”åŠ å¤§ */
        .rate-warning { 
            color: #d32f2f; 
            font-size: 1.2em; /* åŠ å¤§ */
            display: block; 
            margin-top: 2px; 
            font-weight: 900; 
        }
        
        .rate-fail-text { color: #c62828; font-weight: 900; font-size: 0.95em; }
        
        .cutoff-pass-icon { color: #2e7d32; font-size: 0.8em; margin-left: 4px; vertical-align: top; }

        /* åµéŒ¯å€å¡Š */
        #errorBox {
            display: none;
            background: #ffebee;
            color: #c62828;
            border: 2px solid #ef5350;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            text-align: left;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }

        .debug-box { display: none; }
        .footer-deco { text-align: center; margin-top: 20px; font-size: 20px; color: #ccc; }
        th small { opacity: 0.8; font-weight: normal; display: block; margin-top: 2px;}
    </style>
</head>
<body>

<div class="container">
    
    <div class="top-upload-section">
        <span class="btn-box">ğŸ“‚ é¸æ“‡æ¥­ç¸¾æª”æ¡ˆï¼š</span>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
        <div id="statusMsg" style="color: #0d2e53;">(è«‹ä¸Šå‚³æª”æ¡ˆ)</div>
    </div>

    <div id="errorBox"></div>

    <h1>
        <span class="kyushu-icon">ğŸŒ‹</span> ä¹å·é«˜å³°æœƒ <span class="kyushu-icon">â™¨ï¸</span> æ¥­ç¸¾æ’å & A&Hçé‡‘æ˜ç´°
    </h1>

    <div class="dashboard-section">
        <div class="dash-content">
            <div class="dash-table-container">
                <table class="dash-table">
                    <thead>
                        <tr>
                            <th style="text-align:center;">åæ¬¡æˆ°å ±</th>
                            <th style="text-align:center;">ç´¯è¨ˆåŠ è¨ˆFYP (è¬)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="row-rank-name">ç¬¬20å <span class="rank-label">(é¦–å¸­åœ˜)</span></td>
                            <td><input type="number" id="input_rank20" class="dash-input" value="766.1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td class="row-rank-name">ç¬¬90å <span class="rank-label">(åæ¬¡ç)</span></td>
                            <td><input type="number" id="input_rank90" class="dash-input" value="391.1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td class="row-rank-name" style="color:#d32f2f;">ç¬¬1350å <span class="rank-label">(å»ä¹å·)</span></td>
                            <td><input type="number" id="input_rank1350" class="dash-input val-highlight" value="119.1" step="0.1"></td>
                        </tr>
                        <tr>
                            <td class="row-rank-name">ç¬¬2000å <span class="rank-label">(1è¬å…ƒ)</span></td>
                            <td><input type="number" id="input_rank2000" class="dash-input" value="92.6" step="0.1"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="countdown-container">
                <div class="countdown-label">ç«¶è³½å€’æ•¸</div>
                <div class="calendar-icon">
                    <div class="calendar-top"></div>
                    <input type="number" id="input_countdown" class="calendar-input" value="81">
                </div>
            </div>
        </div>
    </div>

    <div id="debugLog" class="debug-box"></div>
    
    <div class="table-wrapper">
        <div id="output"></div>
    </div>
    
    <div class="footer-deco">
        ğŸŒŠ ğŸ¯ ğŸš„ ğŸœ ğŸŒ¸
    </div>
</div>

<script>
    const logBox = document.getElementById('debugLog');
    const statusMsg = document.getElementById('statusMsg');
    const errorBox = document.getElementById('errorBox');
    
    function saveDashboardData() {
        const data = {
            rank20: document.getElementById('input_rank20').value,
            rank90: document.getElementById('input_rank90').value,
            rank1350: document.getElementById('input_rank1350').value,
            rank2000: document.getElementById('input_rank2000').value,
            countdown: document.getElementById('input_countdown').value
        };
        localStorage.setItem('kyushu_dashboard_data', JSON.stringify(data));
        
        if (lastProcessedData) {
            renderTable(lastProcessedData.rows, lastProcessedData.startIdx, lastProcessedData.colMap);
        }
    }

    function loadDashboardData() {
        const saved = localStorage.getItem('kyushu_dashboard_data');
        if (saved) {
            try {
                const data = JSON.parse(saved);
                if(data.rank20) document.getElementById('input_rank20').value = data.rank20;
                if(data.rank90) document.getElementById('input_rank90').value = data.rank90;
                if(data.rank1350) document.getElementById('input_rank1350').value = data.rank1350;
                if(data.rank2000) document.getElementById('input_rank2000').value = data.rank2000;
                if(data.countdown) document.getElementById('input_countdown').value = data.countdown;
            } catch (e) {
                console.error("è®€å–å­˜æª”å¤±æ•—", e);
            }
        }
    }

    const dashInputs = document.querySelectorAll('.dash-input, .calendar-input');
    dashInputs.forEach(input => {
        input.addEventListener('input', saveDashboardData);
    });

    window.addEventListener('DOMContentLoaded', loadDashboardData);

    let lastProcessedData = null;

    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;

        this.value = '';
        errorBox.style.display = 'none';

        document.getElementById('output').innerHTML = '';
        statusMsg.innerText = "â³ è®€å–ä¸­...";
        statusMsg.style.color = "#1565c0";
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                const firstSheetName = workbook.SheetNames[0];
                const ws = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(ws, {header: 1});

                if (!rows || rows.length < 2) {
                    statusMsg.innerText = "âŒ ç¬¬ä¸€å¼µå·¥ä½œè¡¨æ²’æœ‰æ•¸æ“š";
                    statusMsg.style.color = "#d32f2f";
                    return;
                }

                let colMap = {};
                let totalCols = [];
                let dataStartRow = 0;
                let foundHeaders = [];

                for (let r = 0; r < Math.min(rows.length, 20); r++) {
                    const row = rows[r];
                    if (!Array.isArray(row)) continue;
                    row.forEach((cell, idx) => {
                        if (typeof cell !== 'string') return;
                        const c = cell.trim();
                        foundHeaders.push(c);
                        
                        if (c === 'åºè™Ÿ') colMap['Rank'] = idx;
                        else if (c.includes('ä»£è™Ÿ')) colMap['ID'] = idx;
                        else if (c.includes('å§“å')) colMap['Name'] = idx;
                        else if (c.includes('12å·¥æ¥­ç¸¾')) colMap['M12'] = idx;
                        else if (c.includes('13å·¥æ¥­ç¸¾')) colMap['M13'] = idx;
                        else if (c.includes('1å·¥æ¥­ç¸¾')) colMap['M1'] = idx;
                        else if (c.includes('2å·¥æ¥­ç¸¾')) colMap['M2'] = idx;
                        else if (c.includes('3å·¥æ¥­ç¸¾')) colMap['M3'] = idx;
                        else if (c.includes('ç‰¹å®šå•†å“')) colMap['Specific'] = idx;
                        else if (c.includes('13å·¥è²¬ä»»é¡')) colMap['Quota'] = idx;
                        else if (c.includes('è­‰åˆ¸æ‰£é™¤')) colMap['Deduct'] = idx;
                        else if (c.includes('A&H') && c.includes('FYP')) colMap['AH'] = idx;
                        else if (c.includes('ç´¯è¨ˆæ¥­ç¸¾') && c.includes('FYP')) {
                            totalCols.push(idx);
                        }
                        // ä¿®æ­£å¾Œçš„ç¹¼çºŒç‡æŠ“å–é‚è¼¯
                        else {
                            const txt = c.replace(/\s/g, ''); 
                            if (txt.includes('13å€‹æœˆ') || (txt.includes('13') && txt.includes('ç¹¼çºŒ'))) colMap['M13_Rate'] = idx;
                            else if (txt.includes('25å€‹æœˆ') || (txt.includes('25') && txt.includes('ç¹¼çºŒ'))) colMap['M25_Rate'] = idx;
                        }
                    });
                }

                if (totalCols.length > 0) {
                    totalCols.sort((a, b) => a - b);
                    colMap['Total_Excl'] = totalCols[0];
                    colMap['Total_Incl'] = totalCols.length > 1 ? totalCols[totalCols.length - 1] : totalCols[0];
                }

                if (colMap['AH'] === undefined || colMap['Rank'] === undefined) {
                    statusMsg.innerText = "âŒ æ‰¾ä¸åˆ°ç¬¦åˆæ ¼å¼çš„è³‡æ–™";
                    statusMsg.style.color = "#d32f2f";
                    return;
                }

                if (colMap['M13_Rate'] === undefined && colMap['M25_Rate'] === undefined) {
                    errorBox.style.display = 'block';
                    errorBox.innerText = "âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ°ã€Œ13å€‹æœˆã€æˆ–ã€Œ25å€‹æœˆã€ç›¸é—œæ¬„ä½ã€‚\nè«‹ç¢ºèª Excel æ¨™é¡Œæ˜¯å¦æ­£ç¢ºã€‚\n\nç¨‹å¼è®€å–åˆ°çš„æ¨™é¡Œå¦‚ä¸‹ï¼š\n" + foundHeaders.join(", ");
                }

                for(let k=0; k<30; k++) {
                    const testRow = rows[k];
                    if(testRow && testRow[colMap['Rank']] && !isNaN(parseFloat(testRow[colMap['Rank']]))) {
                        dataStartRow = k;
                        break;
                    }
                }
                if(dataStartRow === 0) dataStartRow = 5;

                lastProcessedData = { rows, startIdx: dataStartRow, colMap };

                statusMsg.innerText = "âœ… è¨ˆç®—å®Œæˆï¼";
                statusMsg.style.color = "#2e7d32";
                renderTable(rows, dataStartRow, colMap);

            } catch (err) {
                console.error(err);
                statusMsg.innerText = "âŒ ç¨‹å¼éŒ¯èª¤: " + err.message;
                statusMsg.style.color = "#d32f2f";
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function cleanNum(val) {
        if (typeof val === 'number') return val;
        if (!val) return 0;
        let s = val.toString().replace(/,/g, '').trim();
        if (s === '--' || s === '') return 0;
        let num = parseFloat(s);
        return isNaN(num) ? 0 : num;
    }

    function fmtWan(n) {
        if (n === 0 || isNaN(n)) return '0';
        return (n / 10000).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function fmtRaw(n) {
        if (n === 0 || isNaN(n)) return '0';
        return n.toLocaleString('zh-TW');
    }

    function renderTable(rows, startIdx, colMap) {
        const getVal = (row, key) => colMap[key] !== undefined ? cleanNum(row[colMap[key]]) : 0;
        const getRaw = (row, key) => colMap[key] !== undefined ? (row[colMap[key]] || '') : '';

        const cutoff1350 = parseFloat(document.getElementById('input_rank1350').value) || 119.1;

        let html = `<table>
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th>å§“å</th>
                    <th>12å·¥<small>(è¬)</small></th>
                    <th>13å·¥<small>(è¬)</small></th>
                    <th>1å·¥<small>(è¬)</small></th>
                    <th>2å·¥<small>(è¬)</small></th>
                    <th>3å·¥<small>(è¬)</small></th>
                    <th style="background:var(--col-excl-bg); color:var(--col-excl-text);">ç´¯è¨ˆæ¥­ç¸¾<small>(ä¸å«åŠ è¨ˆ/è¬)</small></th>
                    <th>A&H<small>(è¬)</small></th>
                    <th>ç‰¹å®š<small>(è¬)</small></th>
                    <th>ç¹¼çºŒç‡</th>
                    <th style="background:var(--col-incl-bg); color:var(--col-incl-text); font-size:1.1em;">ç´¯è¨ˆæ¥­ç¸¾<small>(å«åŠ è¨ˆ/è¬)</small></th>
                    <th style="background:var(--col-bonus-bg); color:var(--col-bonus-text);">A&Hçé‡‘</th>
                    <th>ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody>`;

        const P_UNIT = 10000;
        const specialIds = ['EL13016', 'EL13015', 'EL130AE'];
        
        let count = 0;

        for(let i = startIdx; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;

            const rankRaw = getRaw(row, 'Rank');
            const rank = parseFloat(rankRaw);
            const idRaw = getRaw(row, 'ID');
            const id = String(idRaw).trim();
            const name = getRaw(row, 'Name');
            
            if (!rankRaw && !id) continue;

            const m12 = getVal(row, 'M12');
            const m13 = getVal(row, 'M13');
            const m1 = getVal(row, 'M1');
            const m2 = getVal(row, 'M2');
            const m3 = getVal(row, 'M3');
            
            const ahFyp = getVal(row, 'AH');
            const specific = getVal(row, 'Specific');
            const totalExcl = getVal(row, 'Total_Excl');
            const totalIncl = getVal(row, 'Total_Incl');
            const quota = getVal(row, 'Quota');
            const deduct = getVal(row, 'Deduct');

            // --- ç¹¼çºŒç‡è¨ˆç®— (ç¬¦è™Ÿç‰ˆé‚è¼¯) ---
            const raw13 = getRaw(row, 'M13_Rate').toString().trim();
            const raw25 = getRaw(row, 'M25_Rate').toString().trim();
            
            let persistencyHtml = '<span class="status-none">--</span>';
            const hasData = (raw13 !== '' && raw13 !== '--') || (raw25 !== '' && raw25 !== '--');

            if (hasData) {
                // æ”¯æ´ åŠå½¢* èˆ‡ å…¨å½¢ï¼Š
                const hasStar13 = raw13.includes('*') || raw13.includes('ï¼Š');
                const hasStar25 = raw25.includes('*') || raw25.includes('ï¼Š');
                const hasTriangle25 = raw25.includes('â–²'); 

                if (hasStar13 && hasStar25) {
                    // å®Œå…¨é”æ¨™ (13*, 25*)
                    persistencyHtml = '<span style="font-weight:900; color:#2e7d32;">ç¬¦åˆ</span>';
                } else if (hasStar13 && hasTriangle25) {
                    // æ¢ä»¶é”æ¨™ (13*, 25â–²)
                    persistencyHtml = '<span style="font-weight:900; color:#2e7d32;">ç¬¦åˆ</span><br><span class="rate-warning">(è‡ªè²»2.5è¬)</span>';
                } else {
                    // æœªé”æ¨™
                    persistencyHtml = '<span class="rate-fail-text">ç¹¼çºŒç‡ä¸ç¬¦</span>';
                }
            }

            const adjTotal = totalExcl - deduct;
            const target = (100 * P_UNIT) + quota;
            const passTotal = adjTotal >= target;
            
            const passAh = ahFyp >= (24 * P_UNIT);
            let potentialBonus = 0;
            if (passAh) {
                const excess = ahFyp - (24 * P_UNIT);
                if (excess >= P_UNIT) {
                    const pCount = Math.floor(excess / P_UNIT);
                    let rate = 0;
                    if (pCount >= 1 && pCount < 25) rate = 800;
                    else if (pCount >= 25 && pCount < 100) rate = 1000;
                    else if (pCount >= 100) rate = 1200;
                    potentialBonus = pCount * rate;
                }
            }

            const eligible = passTotal && passAh;
            
            let statusHtml = '<span class="status-none">-</span>';
            let rowClass = '';
            let bonusClass = 'col-bonus'; 
            
            if (eligible) {
                statusHtml = '<span class="status-pass">é”æ¨™</span>';
                if (potentialBonus > 0) {
                    rowClass = 'row-winner';
                }
            } else {
                if (!passTotal) {
                    const deficit = target - adjTotal;
                    const deficitWan = (deficit / 10000).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    
                    const kangAiDeficit = deficit / 1.43;
                    const kangAiWan = (kangAiDeficit / 10000).toLocaleString('zh-TW', { minimumFractionDigits: 0, maximumFractionDigits: 2 });

                    statusHtml = `<span class="status-fail">æœªé”æ¨™</span>
                                  <span class="status-diff">(å·® ${deficitWan} è¬)</span>
                                  <span class="status-diff-ka">(åº·æ„›å·® ${kangAiWan} è¬)</span>`;
                    
                    if (potentialBonus > 0) {
                        bonusClass = 'col-bonus-pending';
                    }
                } else if (!passAh) {
                    statusHtml = '<span class="status-none">æœªé”æ¨™</span>';
                }
            }
            
            const bonusHtml = potentialBonus > 0 ? `$${fmtRaw(potentialBonus)}` : '0';

            const totalInclWan = totalIncl / 10000;
            let aboveCutoffHtml = '';
            if (totalInclWan >= cutoff1350) {
                aboveCutoffHtml = '<span class="cutoff-pass-icon" title="é«˜æ–¼æˆ°å ±é–€æª»">âœ…</span>';
            }

            let innovationThreshold = 40 * 10000; 
            if (specialIds.includes(id)) {
                innovationThreshold = 25 * 10000;
            }

            function getMonthCell(val) {
                if (val >= innovationThreshold) {
                    return `<td class="cell-innovation-pass">${fmtWan(val)} <span class="trophy-icon">ğŸ†</span></td>`;
                } else {
                    return `<td class="col-data-highlight">${fmtWan(val)}</td>`;
                }
            }

            let rankHtml = rankRaw;
            let rankClass = "col-rank";
            if (!isNaN(rank) && rank <= 1350) {
                rankClass = "cell-rank-top";
                rankHtml = `<span class="rank-badge">Top</span>${rankRaw}`;
            }

            count++;

            html += `<tr class="${rowClass}">
                <td class="${rankClass}">${rankHtml}</td>
                <td class="col-name">${name}</td>
                <td class="col-data-highlight">${fmtWan(m12)}</td>
                ${getMonthCell(m13)}
                ${getMonthCell(m1)}
                ${getMonthCell(m2)}
                ${getMonthCell(m3)}
                <td class="col-total-excl">${fmtWan(totalExcl)}</td>
                <td class="col-ah-fyp">${fmtWan(ahFyp)}</td>
                <td class="col-data-highlight">${fmtWan(specific)}</td>
                <td>${persistencyHtml}</td>
                <td class="col-total-incl">${fmtWan(totalIncl)}${aboveCutoffHtml}</td>
                <td class="${bonusClass}">${bonusHtml}</td>
                <td>${statusHtml}</td>
            </tr>`;
        }

        html += '</tbody></table>';
        
        if(count === 0) {
            html = '<div style="padding:40px; text-align:center; color:#888;">âš ï¸ æ²’æœ‰è®€å–åˆ°æ•¸æ“šã€‚</div>';
        }

        document.getElementById('output').innerHTML = html;
    }
</script>

</body>
</html>